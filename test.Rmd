---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

Гарри Поттер и системы прогнозирования


Очень часто мы мучаемся вопросом - купить этот актив, или не стоит, вдруг он упадет и я потеряю все деньги, а вдруг наоборот он вырастет и я упущу возможную прибыль?
Я тоже иногда мучаюсь таким вопросом. К счастью - не я один.

Призовём на помощь всю мудрость и магию статистического анализа.
Сейчас моё внимание приковано к движению котировок одного из очень интересных и популярных активов - быстро растет, быстро падает. 
А вот как определить тот самый момент или хотя бы не быть одному в своем прогнозе - попробуем разобраться!

Для начала загрузим информацию о нашем активе:

```{r}
ticker <- read_csv("C:/Users/admin/Downloads/SLVRUB_TOM_FULL_NOTES_2026-02-21.csv") %>% 
  as_tsibble(., key = NULL, index = Date)
glimpse(ticker, width = 60)
```
Попробуем снова применить к данным разложение на тренд и сезонную составляющую с помощью локальной полиномиальной регрессии (Seasonal and Trend decomposition using Loess из исследований аж 1990 года).
Но для начала построим график - убедимся, что данные загружены правильно, попутно выполнив обработку 
возможно пропущенных значений:
```{r}
ticker %>% 
  group_by_key() %>%
  mutate(price = na_locf(Close)) %>%
  ggplot(., aes(Date, Close)) +
  geom_line() + scale_y_log10() +
  theme_minimal()
```

Также иногда полезно посмотреть некоторые с виду несущественные моменты.
Все мы знаем анекдоты Росстата про голубцы и расчеты среднего размера котлеты,
Посчитаем среднемесячную стоимость (цену) актива и объем:

```{r}
# среднемесячная стоимость актива

monthlyP <- ticker %>% 
  group_by_key() %>% 
  index_by(year_month = ~ yearweek(.)) %>% 
  summarise(
    avg_y = mean(Close),
    n = n()
  )

monthlyP

```

Теперь посчитаем объем:
```{r}
monthlyVolume <- ticker %>% 
  group_by_key() %>% 
  index_by(year_month = ~ yearmonth(.)) %>% 
  summarise(
    avg_y = mean(Volume),
    n = n()
  )

monthlyVolume

```
Построим график:
```{r}
monthlyVolume %>% 
  ggplot(., aes(year_month, avg_y)) +
  geom_line() + scale_y_log10() +
  theme_minimal()
```

Мы уже можем заметить, что в сентябре-октябре 2025 года были значительные увеличения объема торгов и соответствующее увеличения цены.
Первое что мы можем предположить - рост объемов связан с ростом цен. Звучит логично.

Проверим на корреляцию:
```{r}
correlation_value <- cor(ticker$Close, ticker$Volume, use = "complete.obs")
correlation_value
```
Интересно, корреляция порядка 84%. По шкале Чеддока это очень сильная корреляция.
Как нам это может помочь в торговле?
На наших данных это означает что когда цена растет, объем торгов тоже имеет тенденцию к росту, и наоборот.
Сила связи в 84.55% случаев изменения цены и объема происходят согласованно в одном направлении.
Т.е. 84% изменения объемов объясняют 84% случаев двиежения цен для данного актива.

Проверим ради академического интереса, сколько раз цена актива пересекала свои медианные линии (n_crossing_points);

```{r}
Crossings_Close = crossing_points(cryptos$Close)

Crossings_Close
```
Получили 11 пересечений. За рассматриваемый период (2025 год + январь-февраль 2026) это примерно 1 пересечение за 1.27 месяца. Уж не намёк ли это на какую-то цикличность или сезонность?

Ок. Смотрим дальше. Нужно выполнить STL-разложение (методом ручного подбора я обнаружил period = 93) достаточно интересным.
Подготовим данные и построим график:
```{r}
stl_prep <- ticker %>% 
  group_by_key() %>% 
  index_by(dt = as.Date(Date)) %>% 
  summarise(y = mean(log(Close))) %>% 
  fill_gaps() %>% 
  mutate(y = forecast::na.interp(y))

stl_prep %>%
  model(STL(y ~ trend(window = 30) + season(period = 93) + season(period = 5))) %>%
  components() %>% 
  autoplot() + theme_minimal()
```

Действительно, хорошо видна некоторая периодичность в 93 дня, о которой мы можем судить, что сейчас движение актива идет на спад или находится в некотором боковом движении, относительно движения основного тренда.

Чем нам это полезно? 
Если движение идет на спад - то скоро появится возможность для входа в покупку или донабора позиции. 

Посмотрим на ключевые моменты, полученные при STL-разложении:
```{r}
features(ticker, Close, features = feature_set(tags = c("stl", "spectral","autocorrelation")))
```
Сила тренда - 98%, сезонных пиков - 6
Пока просто примем к сведению, что тренд очень сильный, а пики обновляются не так уж часто в течение года, скорее стабильно.

Фондовый рынок - это хаос, но в нём есть некоторые закономерности. А где есть закономерности, существуют и аномалии. Посмотрим, есть ли что-то такое, на что нам стоит обратить внимание при принятии решения:

```{r}
anomalies <- ticker %>% 
  time_decompose(Close, method = "stl", merge = TRUE) %>%
  anomalize(remainder) %>%
  time_recompose()

anomalies %>% plot_anomalies()
```
А вот тут уже наша зона интереса. Красными точками отмечены зоны - где было входить рискованно и мы видим как раз те моменты, когда на рынке актива происходила мощная спекулятивная торговля. В феврале 2026 по данным анализа тоже текущее движение актива - аномально. 

Общий итог
Учитывая результаты декомпозии, выявленного возможного затухания движения, наличия аномалий моё мнение - рынок еще не определился.
Для начала цена актива должна быть подтвержеда хорошим объемом.
Для меня это означает, что нужно ждать и не входить.

В следующих статьях на примере этого актива попробуем призвать на помощь предсказателя из Хогвартса, чтобы проверить свои предположения о движении актива.


Гарри Поттер и уроки предсказателей

В прошлой статье я показал, на что можно обратить внимание при анализе актива, основываясь на строгих законах математической статистики (и никакой мистики!).

У меня есть предположение, что цена может пойти или вверх или вниз, к той или иной границе. По сути, я могу кинуть монетку и получить результат 50:50.
На канале Veritasium было интересное видео про экспертные оценки. Так вот - эксперты ошибаются в половине случаев. Просто сами подумайте - люди, которые учились, работали, совершенствовались предсказывают не лучше, чем математически случайная выборка. 

А тут я со своими прогнозами.

Давайте дружно ответим на вопрос в чем разница между предсказанием и прогнозом?
Подумайте минуту, а потом проверьте, правильно ли думаете.

A few moment later.

Так вот. Прогноз это - 
А предсказание - это

Теперь ощущается разница между математиком-статистиком и ретроградной гадалкой в Сатурне?

Мы тоже попробуем прикинуть, куда может пойти цена актива (поиграем в Вангу, но образованную).

Для этого воспользуемся магией Хогвартса и призовём на помощь прогнозиста.
В наше время развития нейронных сетей инструментов расплодилось много, но я использую только проверенные и достоверные (иначе - выверенные) инструменты с сильной научной базой и аргументацией.



Как и большинство прогнозирующих сетей (GARCH, TARCH, LSTM о которых я расскажу в следующих статьях)

Создай обучающие и тренировочные выборки для тестирования моделей prophet и bsts;
Построй прогноз на 2 следующие недели;
Для создания модели с предикторами используй цену закрытия Close и объем Volume;
Я предположу, что между ними есть сильная корреляция - этот факт тоже необходимо проверить. 
